<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SomuNexus | Customer Database</title>
    <link rel="icon" type="image/png" href="icon/Mekxus_logo_no bg.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script>
    (function() {
        // ১. লোকাল স্টোরেজ থেকে ইউজার ডাটা নাও
        const userData = localStorage.getItem('currentUser');
        const adminEmail = "mdsaifhasan724317@gmail.com".toLowerCase().trim();

        // ২. যদি ডাটা একদমই না থাকে (কেউ লগইন করেনি)
        if (!userData) {
            alert("প্রবেশ নিষেধ! আগে লগইন করুন।");
            window.location.href = "login.html";
            return;
        }

        const user = JSON.parse(userData);
        const userEmail = user.email ? user.email.toLowerCase().trim() : "";

        // ৩. যদি লগইন করা থাকে কিন্তু ইমেইল তোমার অ্যাডমিন ইমেইল না হয়
        if (userEmail !== adminEmail) {
            alert("আপনি এই শপ-এর অ্যাডমিন নন! আপনার অ্যাক্সেস ডিনাইড।");
            window.location.href = "index.html"; 
            return;
        }

        // সব ঠিক থাকলে কনসোলে দেখাবে
        console.log("Welcome, Admin Saif!");
    })();
</script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #0b0b0b; color: #fff; padding: 30px; }
        .container { max-width: 1100px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #d4af37; padding-bottom: 15px; margin-bottom: 30px; }
        
        /* Stats Card */
        .stats-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: #111; padding: 20px; border-radius: 12px; border: 1px solid #333; text-align: center; }
        .card h2 { color: #d4af37; margin: 5px 0; font-size: 32px; }

        /* Table Style */
        table { width: 100%; border-collapse: collapse; background: #111; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #222; }
        th { background: #1a1a1a; color: #d4af37; font-size: 14px; text-transform: uppercase; }
        tr:hover { background: #161616; }
        .user-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid #d4af37; }
        
        .badge { background: #d4af37; color: #000; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-user-friends"></i> Customer Management</h1>
        <a href="admin.html" style="color: #888; text-decoration: none;"><i class="fas fa-box"></i> Go to Product Admin</a>
    </div>

    <div class="stats-bar">
        <div class="card">
            <h2 id="uCount">0</h2>
            <p>Total Registered Users</p>
        </div>
        <div class="card">
            <h2 id="oCount">0</h2>
            <p>Total Orders Placed</p>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Profile</th>
                <th>Name</th>
                <th>Contact Info</th>
                <th>Country</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="customerTableBody">
            </tbody>
    </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js"; // এটি যোগ করা হয়েছে

// আপনার Firebase কনফিগারেশন
const firebaseConfig = {
  apiKey: "AIzaSyDNv18tFenJP9XpyL7cr9BaA3vg-gLUC3U",
  authDomain: "somunexas.firebaseapp.com",
  projectId: "somunexas",
  databaseURL: "https://somunexas-default-rtdb.firebaseio.com",
  storageBucket: "somunexas.firebasestorage.app",
  messagingSenderId: "880413975961",
  appId: "1:880413975961:web:838932e24b0644473b1f08"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app); // Auth সার্ভিস চালু করা হলো

// --- এন্ড অ্যাডমিন চেক ---
function checkAdminAccess() {
        // LocalStorage theke user data neya
        const userData = localStorage.getItem('currentUser');
        const adminEmail = "mdsaifhasan724317@gmail.com".toLowerCase().trim();

        // 1. Jodi keu login-i na kore thake (mane localStorage khali)
        if (!userData) {
            alert("Ei page-e dhukte age login korte hobe!");
            window.location.href = "login.html";
            return;
        }

        const currentUser = JSON.parse(userData);
        const loggedInEmail = currentUser.email ? currentUser.email.toLowerCase().trim() : "";

        // 2. Jodi login kora thake kintu email admin-er sathe na mile
        if (loggedInEmail !== adminEmail) {
            alert("Access Denied! Tumi ei shop-er admin nao.");
            window.location.href = "index.html"; // Customer-ke home page-e pathiye deya
            return;
        }

        // Jodi uporer kono condition-e na pore, tar mane se admin
        console.log("Welcome Back, Admin Saif!");
    }

    // পেজ লোড হওয়ার সাথে সাথেই চেক করো
    checkAdminAccess();

/// End ///

document.addEventListener('DOMContentLoaded', () => {
    const tableBody = document.getElementById('customerTableBody');
    const uCount = document.getElementById('uCount');
    const oCount = document.getElementById('oCount');

    // Firebase থেকে ইউজার ডাটা পড়া
    onValue(ref(db, 'users'), (snapshot) => {
        const data = snapshot.val();
        
        if (!data) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No users found in database.</td></tr>`;
            uCount.innerText = "0";
            oCount.innerText = "0";
            return;
        }

        // অবজেক্ট ডাটাকে এরেতে রূপান্তর
        const allUsers = Object.keys(data).map(key => ({
            uid: key,
            ...data[key]
        }));

        console.log("Registered Users from Firebase:", allUsers);

        uCount.innerText = allUsers.length;
        let totalOrders = 0;

        tableBody.innerHTML = allUsers.map(user => {
            const orders = user.orders ? Object.keys(user.orders).length : 0;
            totalOrders += orders;

            return `
                <tr>
                    <td><img src="${user.profilePic || 'https://via.placeholder.com/45'}" class="user-img"></td>
                    <td>
                        <div style="font-weight:bold;">${user.name || 'Anonymous'}</div>
                        <div style="font-size:11px; color:#666;">UID: ${user.uid.substring(0,8)}</div>
                    </td>
                    <td>
                        <div style="font-size:13px;"><i class="fas fa-envelope"></i> ${user.email || 'N/A'}</div>
                        <div style="font-size:13px;"><i class="fas fa-phone"></i> ${user.phone || 'N/A'}</div>
                    </td>
                    <td>${user.country || 'Bangladesh'}</td>
                    <td><span class="badge">${orders} Orders</span></td>
                </tr>
            `;
        }).join('');

        oCount.innerText = totalOrders;
    });
});
</script>

</body>
</html>